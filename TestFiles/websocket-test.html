<!DOCTYPE html>
<html>
<head>
    <title>CollabEditor WebSocket Test Client</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }

        .header {
            background: linear-gradient(135deg, #1f6feb 0%, #388bfd 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
        }

        h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .section-title {
            color: #58a6ff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            padding: 12px 16px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-connected {
            background: #1a7f37;
            color: white;
            border: 2px solid #2ea043;
        }

        .status-disconnected {
            background: #6e7681;
            color: white;
            border: 2px solid #8b949e;
        }

        .input-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #8b949e;
            font-size: 14px;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #1f6feb;
            box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        button {
            padding: 10px 16px;
            background: #238636;
            color: white;
            border: 1px solid #2ea043;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            background: #2ea043;
            box-shadow: 0 0 0 3px rgba(46, 160, 67, 0.3);
        }

        button:disabled {
            background: #21262d;
            border-color: #30363d;
            color: #6e7681;
            cursor: not-allowed;
        }

        button.secondary {
            background: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        button.secondary:hover:not(:disabled) {
            background: #30363d;
            border-color: #8b949e;
        }

        button.danger {
            background: #da3633;
            border-color: #f85149;
        }

        button.danger:hover:not(:disabled) {
            background: #f85149;
            box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.3);
        }

        .messages-container {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message-sent {
            background: #0d4429;
            border-left-color: #2ea043;
        }

        .message-received {
            background: #1c2d41;
            border-left-color: #58a6ff;
        }

        .message-error {
            background: #4c1f1f;
            border-left-color: #f85149;
        }

        .message-success {
            background: #0d4429;
            border-left-color: #56d364;
        }

        .message-info {
            background: #1c2d41;
            border-left-color: #79c0ff;
        }

        .message-time {
            color: #6e7681;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .message-content {
            color: #c9d1d9;
        }

        .message-content pre {
            margin: 8px 0 0 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow-x: auto;
        }

        .message-content strong {
            color: #79c0ff;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat {
            background: #0d1117;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #30363d;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #58a6ff;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #8b949e;
            display: block;
            margin-top: 4px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .info-box {
            background: #1c2d41;
            border: 1px solid #388bfd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .info-box strong {
            color: #79c0ff;
        }

        .participants-list {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            min-height: 100px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 6px;
            background: #161b22;
            border-radius: 4px;
        }

        .participant-name {
            flex: 1;
            font-weight: 600;
        }

        .participant-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #56d364;
        }

        .editor-container {
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 6px;
            padding: 0;
            overflow: hidden;
        }

        .editor-header {
            background: #161b22;
            padding: 12px 15px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            color: #58a6ff;
            font-weight: 600;
            font-size: 14px;
        }

        .editor-info {
            color: #8b949e;
            font-size: 12px;
        }

        #editor {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            background: #0d1117;
            color: #c9d1d9;
            border: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }

        #editor:focus {
            background: #010409;
        }

        #editor::placeholder {
            color: #6e7681;
        }

        .editor-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>üöÄ CollabEditor Multi-Server Test Client</h1>
    <div class="subtitle">Real-time collaborative editing with RabbitMQ sync</div>
</div>

<div class="grid">
    <!-- Connection Section -->
    <div class="section">
        <div class="section-title">üîå Connection Settings</div>

        <div id="status" class="status-indicator status-disconnected">
            <span>‚ö´</span>
            <span>Disconnected</span>
        </div>

        <div class="info-box">
            <strong>Your Participant ID:</strong><br>
            <code id="participantIdDisplay"></code>
        </div>

        <div class="input-group">
            <label>WebSocket Server Port</label>
            <select id="serverPort">
                <option value="5000">Server 1 - Port 5000</option>
                <option value="5001">Server 2 - Port 5001</option>
                <option value="5125">Server 3 - Port 5125</option>
                <option value="custom">Custom Port...</option>
            </select>
        </div>

        <div class="input-group" id="customPortGroup" style="display: none;">
            <label>Custom Port Number</label>
            <input type="number" id="customPort" placeholder="e.g., 5002" value="5002">
        </div>

        <div class="input-group">
            <label>Session ID</label>
            <input type="text" id="sessionId" placeholder="Paste session ID from API">
        </div>

        <div class="input-group">
            <label>Your Name</label>
            <input type="text" id="participantName" placeholder="e.g., Alice" value="Alice">
        </div>

        <div class="button-group">
            <button onclick="connect()" id="connectBtn">
                üîå Connect
            </button>
            <button onclick="disconnect()" id="disconnectBtn" class="danger" disabled>
                ‚ùå Disconnect
            </button>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="section">
        <div class="section-title">üìä Session Stats</div>

        <div class="stats">
            <div class="stat">
                <span class="stat-value" id="versionStat">0</span>
                <span class="stat-label">Version</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="participantsStat">0</span>
                <span class="stat-label">Participants</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="messagesStat">0</span>
                <span class="stat-label">Messages</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="operationsStat">0</span>
                <span class="stat-label">Operations</span>
            </div>
        </div>

        <div class="section-title" style="margin-top: 20px;">üë• Active Participants</div>
        <div id="participantsList" class="participants-list">
            <div style="color: #6e7681; text-align: center; padding: 20px;">
                No participants yet
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="section" style="margin-bottom: 20px;">
    <div class="section-title">‚ö° Quick Actions</div>

    <div class="quick-actions">
        <button onclick="sendPing()" id="pingBtn" class="secondary" disabled>
            üèì Ping
        </button>
        <button onclick="createSession()" id="createBtn" class="secondary">
            ‚ûï Create Session
        </button>
        <button onclick="clearMessages()" class="secondary">
            üóëÔ∏è Clear Messages
        </button>
    </div>
</div>

<!-- Collaborative Editor Section -->
<div class="section" style="margin-bottom: 20px;">
    <div class="section-title">üìù Collaborative Text Editor</div>

    <div class="editor-container">
        <div class="editor-header">
            <div class="editor-title">Document Content</div>
            <div class="editor-info">
                <span id="editorStatus">Disconnected</span> ‚Ä¢
                <span id="charCount">0</span> characters
            </div>
        </div>
        <textarea
            id="editor"
            placeholder="Connect to a session to start collaborative editing...&#10;&#10;Your changes will automatically sync with all connected users!"
            disabled
        ></textarea>
    </div>
</div>

<!-- Operations Section -->
<div class="section" style="margin-bottom: 20px;">
    <div class="section-title">‚úèÔ∏è Send Operations (Manual)</div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
        <div class="input-group" style="margin: 0;">
            <label>Text to Insert</label>
            <input type="text" id="operationText" placeholder="Type text here" value="Hello ">
        </div>
        <div class="input-group" style="margin: 0;">
            <label>Position</label>
            <input type="number" id="operationPosition" placeholder="0" value="0" min="0">
        </div>
    </div>

    <div class="button-group">
        <button onclick="sendInsert()" id="insertBtn" disabled>
            ‚ûï Insert Text
        </button>
        <button onclick="sendDelete()" id="deleteBtn" class="danger" disabled>
            ‚ûñ Delete (5 chars)
        </button>
    </div>
</div>

<!-- Messages Log -->
<div class="section">
    <div class="section-title">üì® Messages Log</div>
    <div id="messages" class="messages-container"></div>
</div>

<script>
    let ws = null;
    let participantId = crypto.randomUUID();
    let currentVersion = 0;
    let sessionId = null;
    let participants = new Map();
    let messageCount = 0;
    let operationCount = 0;

    // Collaborative editor state
    let documentContent = '';
    let isApplyingRemoteOperation = false;
    const editorElement = document.getElementById('editor');

    // Initialize
    document.getElementById('participantIdDisplay').textContent = participantId;

    // Editor event listeners
    editorElement.addEventListener('input', handleEditorInput);
    editorElement.addEventListener('keydown', handleEditorKeydown);

    // Handle port selection
    document.getElementById('serverPort').addEventListener('change', function() {
        const customGroup = document.getElementById('customPortGroup');
        if (this.value === 'custom') {
            customGroup.style.display = 'block';
        } else {
            customGroup.style.display = 'none';
        }
    });

    // ========== Collaborative Editor Functions ==========

    function handleEditorInput(event) {
        if (isApplyingRemoteOperation) {
            console.log('Skipping input handling - applying remote operation');
            return;
        }

        if (!ws) {
            console.log('Skipping input handling - no WebSocket connection');
            return;
        }

        const newContent = editorElement.value;
        const cursorPosition = editorElement.selectionStart;

        console.log('handleEditorInput - old content:', documentContent);
        console.log('handleEditorInput - new content:', newContent);

        // Update character count
        document.getElementById('charCount').textContent = newContent.length;

        // Detect what changed
        const diff = findDifference(documentContent, newContent);

        console.log('Detected diff:', diff);

        if (diff) {
            documentContent = newContent;

            if (diff.type === 'insert') {
                console.log('Sending INSERT operation:', diff);
                sendOperationAuto({
                    type: 'insert',
                    position: diff.position,
                    text: diff.text,
                    version: currentVersion
                });
            } else if (diff.type === 'delete') {
                console.log('Sending DELETE operation:', diff);
                sendOperationAuto({
                    type: 'delete',
                    position: diff.position,
                    length: diff.length,
                    version: currentVersion
                });
            }
        }
    }

    function handleEditorKeydown(event) {
        // Update character count on delete/backspace
        if (event.key === 'Backspace' || event.key === 'Delete') {
            setTimeout(() => {
                document.getElementById('charCount').textContent = editorElement.value.length;
            }, 0);
        }
    }

    function findDifference(oldText, newText) {
        // Find the position where the texts differ
        let i = 0;
        while (i < oldText.length && i < newText.length && oldText[i] === newText[i]) {
            i++;
        }

        // If texts are the same
        if (i === oldText.length && i === newText.length) {
            return null;
        }

        // Find the position from the end where they differ
        let j = 0;
        while (j < oldText.length - i && j < newText.length - i &&
               oldText[oldText.length - 1 - j] === newText[newText.length - 1 - j]) {
            j++;
        }

        const oldEnd = oldText.length - j;
        const newEnd = newText.length - j;

        // Determine if it's an insert or delete
        if (i === oldEnd) {
            // Insert
            return {
                type: 'insert',
                position: i,
                text: newText.substring(i, newEnd)
            };
        } else if (i === newEnd) {
            // Delete
            return {
                type: 'delete',
                position: i,
                length: oldEnd - i
            };
        } else {
            // Replace (treat as delete + insert, we'll just do insert for simplicity)
            // This handles the case where text is selected and replaced
            return {
                type: 'insert',
                position: i,
                text: newText.substring(i, newEnd),
                deletedLength: oldEnd - i
            };
        }
    }

    function sendOperationAuto(operation) {
        if (!ws || !sessionId) return;

        const operationMessage = {
            type: 'operation',
            sessionId: sessionId,
            operation: operation
        };

        console.log('sendOperationAuto - sending:', operationMessage);
        ws.send(JSON.stringify(operationMessage));
    }

    function applyOperationToEditor(operation) {
        console.log('applyOperationToEditor called with:', operation);

        const cursorPosition = editorElement.selectionStart;
        const content = editorElement.value;

        console.log('Current cursor position:', cursorPosition);
        console.log('Current content length:', content.length);

        isApplyingRemoteOperation = true;

        if (operation.type === 'insert') {
            console.log('Applying INSERT operation');
            console.log('Position:', operation.position, 'Text:', operation.text);

            const before = content.substring(0, operation.position);
            const after = content.substring(operation.position);
            documentContent = before + operation.text + after;
            editorElement.value = documentContent;

            console.log('New content:', documentContent);

            // Adjust cursor position if needed
            if (cursorPosition >= operation.position) {
                const newCursorPos = cursorPosition + operation.text.length;
                editorElement.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                editorElement.setSelectionRange(cursorPosition, cursorPosition);
            }
        } else if (operation.type === 'delete') {
            console.log('Applying DELETE operation');
            console.log('Position:', operation.position, 'Length:', operation.length);

            const before = content.substring(0, operation.position);
            const after = content.substring(operation.position + operation.length);
            documentContent = before + after;
            editorElement.value = documentContent;

            console.log('New content:', documentContent);

            // Adjust cursor position if needed
            if (cursorPosition > operation.position + operation.length) {
                const newCursorPos = cursorPosition - operation.length;
                editorElement.setSelectionRange(newCursorPos, newCursorPos);
            } else if (cursorPosition > operation.position) {
                editorElement.setSelectionRange(operation.position, operation.position);
            } else {
                editorElement.setSelectionRange(cursorPosition, cursorPosition);
            }
        }

        // Update character count
        document.getElementById('charCount').textContent = documentContent.length;

        isApplyingRemoteOperation = false;
        console.log('Operation applied, isApplyingRemoteOperation reset to false');
    }

    function updateEditorStatus(connected) {
        const statusSpan = document.getElementById('editorStatus');
        if (connected) {
            statusSpan.textContent = 'Connected & Syncing';
            statusSpan.style.color = '#56d364';
            editorElement.disabled = false;
            editorElement.classList.remove('editor-disabled');
        } else {
            statusSpan.textContent = 'Disconnected';
            statusSpan.style.color = '#8b949e';
            editorElement.disabled = true;
            editorElement.classList.add('editor-disabled');
            documentContent = '';
            editorElement.value = '';
            document.getElementById('charCount').textContent = '0';
        }
    }

    // ========== End Collaborative Editor Functions ==========

    function log(message, type = 'received') {
        messageCount++;
        updateStats();

        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;

        const time = new Date().toLocaleTimeString();
        messageDiv.innerHTML = `
                <div class="message-time">[${time}]</div>
                <div class="message-content">${message}</div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateStats() {
        document.getElementById('versionStat').textContent = currentVersion;
        document.getElementById('participantsStat').textContent = participants.size;
        document.getElementById('messagesStat').textContent = messageCount;
        document.getElementById('operationsStat').textContent = operationCount;
    }

    function updateParticipantsList() {
        const listDiv = document.getElementById('participantsList');

        if (participants.size === 0) {
            listDiv.innerHTML = '<div style="color: #6e7681; text-align: center; padding: 20px;">No participants yet</div>';
            return;
        }

        listDiv.innerHTML = '';
        participants.forEach((name, id) => {
            const item = document.createElement('div');
            item.className = 'participant-item';
            item.innerHTML = `
                    <div class="participant-status"></div>
                    <div class="participant-name">${name}</div>
                    <code style="font-size: 10px; color: #6e7681;">${id.substring(0, 8)}...</code>
                `;
            listDiv.appendChild(item);
        });
    }

    function updateStatus(connected) {
        const statusDiv = document.getElementById('status');
        const buttons = {
            connect: document.getElementById('connectBtn'),
            disconnect: document.getElementById('disconnectBtn'),
            ping: document.getElementById('pingBtn'),
            insert: document.getElementById('insertBtn'),
            delete: document.getElementById('deleteBtn')
        };

        if (connected) {
            statusDiv.innerHTML = '<span>üü¢</span><span>Connected</span>';
            statusDiv.className = 'status-indicator status-connected';
            buttons.connect.disabled = true;
            buttons.disconnect.disabled = false;
            buttons.ping.disabled = false;
            buttons.insert.disabled = false;
            buttons.delete.disabled = false;
        } else {
            statusDiv.innerHTML = '<span>‚ö´</span><span>Disconnected</span>';
            statusDiv.className = 'status-indicator status-disconnected';
            buttons.connect.disabled = false;
            buttons.disconnect.disabled = true;
            buttons.ping.disabled = true;
            buttons.insert.disabled = true;
            buttons.delete.disabled = true;
        }

        // Update editor status
        updateEditorStatus(connected);
    }

    async function createSession() {
        const portSelect = document.getElementById('serverPort');
        let port = portSelect.value;
        if (port === 'custom') {
            port = document.getElementById('customPort').value;
        }

        try {
            log('üì° Creating new session...', 'info');

            const response = await fetch(`http://localhost:${port}/api/sessions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    initialContent: 'Welcome to the collaborative editor!'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            document.getElementById('sessionId').value = data.sessionId;

            log(`‚úÖ <strong>Session created!</strong><br>ID: ${data.sessionId}<br>Content: "${data.content}"`, 'success');
        } catch (error) {
            log(`‚ùå <strong>Failed to create session:</strong> ${error.message}`, 'error');
        }
    }

    function connect() {
        sessionId = document.getElementById('sessionId').value.trim();
        const name = document.getElementById('participantName').value.trim();

        if (!sessionId) {
            alert('‚ùå Please enter a session ID (or create a new session)');
            return;
        }

        if (!name) {
            alert('‚ùå Please enter your name');
            return;
        }

        const portSelect = document.getElementById('serverPort');
        let port = portSelect.value;
        if (port === 'custom') {
            port = document.getElementById('customPort').value;
        }

        const wsUrl = `ws://localhost:${port}/ws?participantId=${participantId}`;

        log(`üîå Connecting to ${wsUrl}...`, 'info');
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            log('‚úÖ <strong>WebSocket connected!</strong>', 'success');
            updateStatus(true);

            const joinMessage = {
                type: 'join',
                sessionId: sessionId,
                name: name
            };

            ws.send(JSON.stringify(joinMessage));
            log(`üì§ <strong>SENT:</strong><pre>${JSON.stringify(joinMessage, null, 2)}</pre>`, 'sent');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            log(`üì• <strong>RECEIVED:</strong><pre>${JSON.stringify(message, null, 2)}</pre>`, 'received');

            handleMessage(message);
        };

        ws.onerror = (error) => {
            log(`‚ùå <strong>WebSocket error</strong>`, 'error');
        };

        ws.onclose = () => {
            log('üîå <strong>WebSocket disconnected</strong>', 'info');
            updateStatus(false);
            participants.clear();
            updateParticipantsList();
            updateStats();
        };
    }

    function handleMessage(message) {
        switch(message.type) {
            case 'joined':
                currentVersion = message.version;
                participants.clear();
                message.participants.forEach(p => {
                    participants.set(p.id, p.name);
                });
                updateParticipantsList();
                updateStats();
                log(`‚úÖ <strong>Joined session successfully!</strong><br>Version: ${currentVersion}<br>Content: "${message.content}"<br>Participants: ${participants.size}`, 'success');

                // Initialize editor with document content
                documentContent = message.content || '';
                isApplyingRemoteOperation = true;
                editorElement.value = documentContent;
                document.getElementById('charCount').textContent = documentContent.length;
                isApplyingRemoteOperation = false;
                break;

            case 'operation-applied':  // FIXED: Changed from 'operationApplied' to match server format
                operationCount++;
                currentVersion = message.operation.version;
                updateStats();

                // Debug logging
                console.log('Received operation:', message.operation);
                console.log('Operation authorId:', message.operation.authorId);
                console.log('My participantId:', participantId);

                // IMPORTANT: Ignore operations we sent ourselves (already applied locally)
                if (message.operation.authorId === participantId) {
                    console.log('Ignoring own operation - already applied locally');
                    log(`‚úÖ <strong>Own operation confirmed by server</strong><br>Type: ${message.operation.type}<br>Version: ${currentVersion}`, 'info');
                    break;
                }

                console.log('Applying remote operation from another user');
                console.log('Current editor content:', editorElement.value);
                console.log('Current documentContent:', documentContent);

                log(`‚úÖ <strong>Remote operation applied!</strong><br>Type: ${message.operation.type}<br>Position: ${message.operation.position}<br>Text: "${message.operation.text || ''}"<br>Length: ${message.operation.length || 'N/A'}<br>Version: ${currentVersion}<br>From: ${message.operation.authorId.substring(0, 8)}...`, 'success');

                // Apply operation to the editor (only from other users)
                applyOperationToEditor(message.operation);

                console.log('After applying - editor content:', editorElement.value);
                console.log('After applying - documentContent:', documentContent);
                break;

            case 'participant-joined':  // FIXED: Changed from 'participantJoined' to match server format
                participants.set(message.participantId, message.name);
                updateParticipantsList();
                updateStats();
                log(`üëã <strong>${message.name} joined!</strong>`, 'success');
                break;

            case 'participant-left':  // FIXED: Changed from 'participantLeft' to match server format
                const leftName = participants.get(message.participantId) || 'Unknown';
                participants.delete(message.participantId);
                updateParticipantsList();
                updateStats();
                log(`üëã <strong>${leftName} left</strong>`, 'info');
                break;

            case 'pong':
                log(`üèì <strong>Pong received!</strong>`, 'success');
                break;

            case 'error':
                log(`‚ùå <strong>ERROR:</strong> ${message.error}<br>Code: ${message.errorCode || 'N/A'}`, 'error');
                break;
        }
    }

    function disconnect() {
        if (ws && sessionId) {
            const leaveMessage = {
                type: 'leave',
                sessionId: sessionId
            };

            ws.send(JSON.stringify(leaveMessage));
            log(`üì§ <strong>SENT:</strong><pre>${JSON.stringify(leaveMessage, null, 2)}</pre>`, 'sent');

            setTimeout(() => {
                ws.close();
                ws = null;
            }, 500);
        }
    }

    function sendPing() {
        if (!ws) return;

        const pingMessage = { type: 'ping' };
        ws.send(JSON.stringify(pingMessage));
        log(`üì§ <strong>SENT:</strong><pre>${JSON.stringify(pingMessage)}</pre>`, 'sent');
    }

    function sendInsert() {
        if (!ws) return;

        const text = document.getElementById('operationText').value;
        const position = parseInt(document.getElementById('operationPosition').value) || 0;

        const operationMessage = {
            type: 'operation',
            sessionId: sessionId,
            operation: {
                type: 'insert',
                position: position,
                text: text,
                version: currentVersion
            }
        };

        ws.send(JSON.stringify(operationMessage));
        log(`üì§ <strong>SENT:</strong><pre>${JSON.stringify(operationMessage, null, 2)}</pre>`, 'sent');
    }

    function sendDelete() {
        if (!ws) return;

        const position = parseInt(document.getElementById('operationPosition').value) || 0;

        const operationMessage = {
            type: 'operation',
            sessionId: sessionId,
            operation: {
                type: 'delete',
                position: position,
                length: 5,
                version: currentVersion
            }
        };

        ws.send(JSON.stringify(operationMessage));
        log(`üì§ <strong>SENT:</strong><pre>${JSON.stringify(operationMessage, null, 2)}</pre>`, 'sent');
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
        messageCount = 0;
        operationCount = 0;
        updateStats();
    }

    // Initial instructions
    log(`üÜî <strong>Your Participant ID:</strong> ${participantId}`, 'info');
    log(`üí° <strong>Quick Start:</strong><br>1. Click "Create Session" to make a new session<br>2. Select your server port<br>3. Enter your name<br>4. Click "Connect"<br>5. Try sending operations!`, 'info');
</script>
</body>
</html>